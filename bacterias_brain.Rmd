---
title: 'Molecular Mechanisms for Human Diseases: Lab 1'
subtitle: "Bacteria's Brain -- Part A"
date: (`r Sys.Date()`)
output:
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(glue)
theme_set(theme_minimal())

```

##Results:

```{r import data}
#import A;
novick_a <- read.csv("data/g149novickA.csv", header = FALSE) 
novick_a <- novick_a %>%   
  # separate columns and add titles;
  separate_wider_delim(1, ",", names = c("t", "concentration")) %>%
  # render as number
  mutate_if(is.character, as.numeric) %>%
  # show result
  print()

#import B; 
novick_b <- read.csv("data/g149novickB.csv", header = FALSE) 
novick_b <- novick_b %>%   
  # separate columns and add titles;
  separate_wider_delim(1, ",", names = c("t", "concentration")) %>% 
  # render as number
  mutate_if(is.character, as.numeric) %>%
  # show result
  print()

```

Visualization of Data set A and B

```{r a_Q1}

# combine both datasets
data_comb <- novick_a %>% 
  mutate(data = "high concentration") %>%
  rbind(mutate(novick_b, data = "low concentration"))
  

data_comb %>%
  ggplot(aes(x = t, y = concentration)) +
  labs(
    title = expression(paste("Growth of  ", beta, "-gal")), 
    subtitle = "In response to high and low TMG concentration",
    x = "time (hours)", 
    y = expression(paste("concentration of  ", beta, "-gal"))
  ) + geom_point() +
  facet_wrap(~data_comb$data, scales = "free_x")

```

##Analysis:

### Fitting function on Data set A

### derivation:

I will first define the different terms that will be used. $N$ is the number of individual E.coli bacteria in the chemostat, which is maintained at a constant value. $Q$ is the flow rate both in- and outward from the chemostat, which is kept at a constant value so that $N$ can be kept constant. $V$ is the volume of the chemostat $S$ we define as the rate of production by any individual bacterium at a given time. According to Hypothesis A, S is constant; but according Hypothesis B, S is a function of time. $z$ is defined as the concentration of \beta-gal within the system at any moment. With these terms defined, we observe that at any moment, the growth of \beta-gal is $\frac{dz}{dt}$, which equates two terms: the rate of production by the bacteria and the rate of loss due to flow rate. Hence we get the equation: $$\frac{dz}{dt} = Ns - \frac{Qz}{V}$$

```{r a_q2}
#define function
growth_a <- function (t, ampl, tau) (ampl*(1- exp(-(t/tau))))
  
#fit function without (0,0)
a_q2_fn <- nls(novick_a$concentration ~ growth_a(t, ampl, tau), data = novick_a, start = list(ampl = 1.26, tau = 2.62))

# store coefficients
coef_a2 <- coef(a_q2_fn)

# plot fitted curve over data
novick_a %>%
  ggplot(aes(x = t, y = concentration)) + 
  geom_point(data = novick_a) + 
  labs( 
    title = expression(paste("Growth of  ", beta, "-gal")), 
    subtitle = "in response to high TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("concentration of  ", beta, "-gal"))
  )+
  stat_function(fun = growth_a, 
                args = c(ampl = coef_a2[[1]], 
                         tau = coef_a2[[2]]))
```

With the coefficients calculated, the nonlinear fitting of A results in the function:

$$z(t) = A(1 - e^{-\frac{t}{\tau}})$$ With A = `r signif(coef_a2[[1]], 3)` and \tau = `r signif(coef_a2[[2]], 3)` We observe that at $t = 0$, $z(t) = 0$, which is valid in its physical meaning, as there would be no \beta-gal before any inducers are introduced. Hence, the data point $(0,0)$ is included into the data and the same model is fitted again.

```{r a_q3}

#fit data with (0,0)

# add (0,0) to data
a_q3_df <- novick_a %>%
  rbind(c(0,0))
# fit data again
a_q3_fit <- nls(a_q3_df$concentration ~ growth_a(t, ampl, tau), data = a_q3_df, start = list(ampl = 1.26, tau = 2.62))

coef_a3 <- coef(a_q3_fit)

coef_comp <- coef_a2 %>% 
  rbind (coef_a3) %>%
  print()
print(summary(a_q3_fit))
# plot new fitted curve over data
a_q3_df %>%
  ggplot(aes(x = t, y = concentration)) + 
  geom_point(color = "blue")+
  geom_point(data = novick_a) + 
  labs( 
    title = expression(paste("Growth of  ", beta, "-gal")), 
    subtitle = "in response to high TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("concentration of  ", beta, "-gal"))
  )+
  stat_function(color = "blue", 
    fun = growth_a, 
                args = c(ampl = coef_a3[[1]], 
                         tau = coef_a3[[2]]))

```

We see that here the two fitting parameters are identical before and after $(0,0)$ is included.

Fitting function on Data set B

```{r b_q2}
# get data for 10<=t<=15
b_q2 <- novick_b %>% 
  filter(t >= 10) %>% 
  filter(t <= 15)
# fit straight line for 10<= t <= 15

b_q2_fit <- lm(b_q2$concentration ~ b_q2$t)
coef_b2 <- coef(b_q2_fit)
b_q2_summ <- summary(b_q2_fit)

print(coef_b2)

  # plot
novick_b %>%
  ggplot(aes(x = t, y = concentration)) + 
  geom_point(color = "blue") + 
  geom_point(data = b_q2, aes(color = "red"))+ 
  labs(
    title = expression(paste("Growth of  ", beta, "-gal")), 
    subtitle = "in response to lower TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("fraction of maximum  ", beta, "-gal"))
  ) + 
  geom_abline(color = "red",
    intercept = coef_b2[[1]], 
    slope = coef_b2[[2]])  + 
  theme(legend.position = "none")

# compare fit
print(b_q2_summ)

# fit same line over the entire dataset
# predict with linear model with entire dataset
b_q2_pred <- predict(b_q2_fit, newdata = data.frame(t = b_q2$t))
b_q2_mse <- mean((b_q2$concentration - b_q2_pred)^2)

b_q2_pred_all <- predict(b_q2_fit, newdata = data.frame(t = novick_b$t))
b_q2_mse_all <- mean((novick_b$concentration - b_q2_pred_all)^2)

tibble(MSE = c(b_q2_mse, b_q2_mse_all)) %>%
  signif(3) %>%
  mutate(data = c("10<= t <= 15", "entire dataset")) %>%
  print()


```

As we can see, the Mean Standard Error (MSE) for the model fits well within the range of 10\<= t \<= 15, but not well over the entire data set.

```{r b_q3}
# fit function from a
# define function
growth_b3 <- function (t, ampl, tau) (ampl*(1- exp(-(t/tau))))

# generate an example function
# downscale function from A

# plot the fitted function
novick_b %>%
  ggplot(aes(x = t, y = concentration)) + 
  geom_point() + 
  labs( 
    title = expression(paste("Growth of  ", beta, "-gal")), 
    subtitle = "in response to lower TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("fraction of maximum  ", beta, "-gal"))
  )  +
  stat_function(fun = growth_b3, 
                args = c(ampl = 0.4, 
                         tau = 7))
```

```{r b_q4}
# Separate data for t<= 15

b_q4_df <- novick_b %>%
  filter(t <= 15)


# define function
growth_b4 <- function (t, beta, tau) (beta * (-1 + t/tau + exp(-t/tau)))

# fit function
b_q4 <- nls(b_q4_df$concentration ~ growth_b4(t, beta, tau), 
            data = b_q4_df, start = list(beta = 1, tau = 3.9))

coef_b4 <- coef(b_q4)

# plot the new fitted function
# the data of t>15 is in blue and the rest is in red

b_q4_df %>%
  ggplot(aes(x = t, y = concentration)) + 
  geom_point(data = novick_b, color = "red")+
  geom_point(color = "blue") + 
  labs( 
    title = expression(paste("Growth of  ", beta, "-gal")), 
    subtitle = "in response to high TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("fraction of maximum  ", beta, "-gal"))
    )  +
  geom_abline(color = "red",
              intercept = coef_b2[[1]], 
              slope = coef_b2[[2]]) +
  stat_function(fun = growth_b4, 
                args = c(beta = coef_b4[[1]], 
                         tau = coef_b4[[2]])) +
  theme(legend.position = "none")
```

Q5: at large t, the function becomes linear as -t/tau becomes 0 so exp(-t/tau) becomes a constant of 1

Analysis:
