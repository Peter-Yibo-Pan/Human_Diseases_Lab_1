---
title: 'Molecular Mechanisms for Human Diseases: Lab 1'
subtitle: "Bacteria's Brain -- Part A"
author: "Peter Yibo Pan, collaborators: "
date: (`r Sys.Date()`)
output:
  word_document:
    reference_docx: reference-word.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(glue)
library(knitr)
theme_set(theme_minimal())

```

##Results:
The complete resulting data can be seen in tables 1 and 2 in the appendix, and as shown in table 1a and 1b: 
```{r import data}
#import A;
novick_a <- read.csv("data/g149novickA.csv", header = FALSE) 
novick_a <- novick_a %>%   
  # separate columns and add titles;
  separate_wider_delim(1, ",", names = c("t", "concentration")) %>%
  # render as number
  mutate_if(is.character, as.numeric)

#import B; 
novick_b <- read.csv("data/g149novickB.csv", header = FALSE) 
novick_b <- novick_b %>%   
  # separate columns and add titles;
  separate_wider_delim(1, ",", names = c("t", "concentration")) %>% 
  # render as number
  mutate_if(is.character, as.numeric) 
kable(signif(novick_b, 3))

```

Visualization of Data set A and B

```{r a_Q1}

# combine both datasets
data_comb <- novick_a %>% 
  mutate(data = "high concentration") %>%
  rbind(mutate(novick_b, data = "low concentration"))
  

data_comb %>%
  ggplot(aes(x = t, y = concentration)) +
  labs(
    title = expression(paste("Figure 1: Growth of  ", beta, "-gal")), 
    subtitle = "In response to high and low inducer concentration",
    x = "time (hours)", 
    y = expression(paste("concentration of  ", beta, "-gal"))
  ) + geom_point() +
  facet_wrap(~data_comb$data, scales = "free_x")

```

## Analysis:

### Derivation of Functions used for fitting both datasets:

I will first define the different terms that will be used.

$N$ is the number of individual E.coli bacteria in the chemostat, which is maintained at a constant value.

$Q$ is the flow rate both in- and outward from the chemostat, which is kept at a constant value so that $N$ can be kept constant.

$V$ is the volume of the chemostat

$S$ we define as the average rate of production by any individual bacterium at a given time. Note this is not the rate of production by individual bacterium but the mean of the population. Hence this value would change based on how many bacterium are "activated" within the population. 

$z$ is defined as the concentration of \beta-gal within the system at any moment. With these terms defined, we observe that at any moment, the growth of \beta-gal is $\frac{dz}{dt}$, which equates two terms: the rate of production by the bacteria and the rate of loss due to flow rate. Hence we get the equation: $$\frac{dz}{dt} = Ns - \frac{Q}{V}z$$

#### A: High Concentration of Inducers  
For data set A, when the inducers are introduced at high concentration, we assume that $S$  is constant as all bacteria rapidly "switches on" and generates enzyme at its maximal rate. We can then express $t$ as a dimensionless variable as $\tilde{t} \frac{V}{Q}$, hence: 

$$\frac{dz}{d\tilde{t}} = \frac{V N S}{Q} - z $$
We can prepare the function for integration by substituting $\frac{NSV}{Q} = A$: 
$$\frac{1}{A - z} dz = d\tilde{t}$$
We then integrate both sides: 
$$\int \frac{1}{A - z} dz = \int d\tilde{t}$$
$$-\ln|A-z| = \tilde{t} + C$$
$$A - z = e^{-\tilde{t}-C}$$
$$z = A - e^{-\tilde{t}} e^{C}$$
Considering the fact that $z(0) = 0$, we conclude that $e^{C} = A$
Hence: 
$$z = A(1 - e^{-\tilde{t}})$$
We substitute $A$ and $\tilde{t}$ with their original values: 
$$z = \frac{NSV}{Q} (1 - e^{-\frac{Q}{V}t})$$
 
#### B: Low concentration of Inducers  
For data set B, when the inducers are introduced at low concentration, only a fraction of bacteria is activated, with this fraction slowly growing. Hence we assume that $S$ is a linear function of $\tilde{t}$  with $S(\tilde{t}) = \alpha \tilde{t}$ and \alpha being the rate at which activation "spreads" through the population. 
Hence we again start with the equation: 
$$\frac{dz}{d\tilde{t}} = \frac{V N S}{Q} - z $$
However, we substitute $S$ as a function of t
$$\frac{dz}{d\tilde{t}} = \frac{V N \alpha}{Q}\tilde{t} - z $$
Again using a dimensionless substitution, this time for $z$ as $z = \frac{VN\alpha}{Q} \tilde{z} $
We arrive at 
$$\frac{d\tilde{z}}{d\tilde{t}} = \tilde{t} - \tilde{z} $$

### Fitting function on Data set A
From the derived equation A: $z = \frac{NSV}{Q} (1 - e^{-\frac{Q}{V}t})$, we set the two parameters $A = \frac{NSV}{Q} $ and $\tau = \frac{V}{Q}$ so the equation is of the form: 
$$z = A(1 - e^{-\frac{t}{\tau}})$$

```{r a_q2}
#define function
growth_a <- function (t, ampl, tau) (ampl*(1- exp(-(t/tau))))
  
#fit function without (0,0)
a_q2_fn <- nls(novick_a$concentration ~ growth_a(t, ampl, tau), data = novick_a, start = list(ampl = 1.26, tau = 2.62))

# store coefficients
coef_a2 <- coef(a_q2_fn)
coef_a2_df <- data.frame(data = "dataset A", values = signif(coef_a2, 4))

# plot fitted curve over data
novick_a %>%
  ggplot(aes(x = t, y = concentration)) + 
  geom_point(data = novick_a) + 
  labs( 
    title = expression(paste("Figure 2: Growth of  ", beta, "-gal")), 
    subtitle = "in response to high TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("concentration of  ", beta, "-gal"))
  )+
  stat_function(fun = growth_a, 
                args = c(ampl = coef_a2[[1]], 
                         tau = coef_a2[[2]]))
kable(coef_a2_df)
```

With the coefficients calculated, the nonlinear fitting of A results in the function:

$$z(t) = A(1 - e^{-\frac{t}{\tau}})$$ With A = `r signif(coef_a2[[1]], 3)` and \tau = `r signif(coef_a2[[2]], 3)` We observe that at $t = 0$, $z(t) = 0$, which is valid in its physical meaning, as there would be no \beta-gal before any inducers are introduced. Hence, the data point $(0,0)$ is included into the data and the same model is fitted again.

```{r a_q3}

#fit data with (0,0)

# add (0,0) to data
a_q3_df <- novick_a %>%
  rbind(c(0,0))
# fit data again
a_q3_fit <- nls(a_q3_df$concentration ~ growth_a(t, ampl, tau), data = a_q3_df, start = list(ampl = 1.26, tau = 2.62))

coef_a3 <- coef(a_q3_fit)
coef_comp <- coef_a2 %>% 
  rbind (data.frame(data = "with (0,0)", values = signif(coef(a_q3_fit), 4))) 

# plot new fitted curve over data
a_q3_df %>%
  ggplot(aes(x = t, y = concentration)) + 
  geom_point(color = "blue")+
  geom_point(data = novick_a) + 
  labs( 
    title = expression(paste("Figure 3: Growth of  ", beta, "-gal")), 
    subtitle = "in response to high TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("concentration of  ", beta, "-gal"))
  )+
  stat_function(color = "blue", 
                fun = growth_a, 
                args = c(ampl = coef_a3[[1]], 
                         tau = coef_a3[[2]]))
kable(coef_comp)
print(summary(a_q3_fit))

## predict and calculate MSE for model
a_q3_pred <- predict(a_q3_fit, newdata = data.frame(t = a_q3_df$t))
a_q3_mse <- mean((a_q3_df$concentration - a_q3_pred)^2)

```

We see that here the two fitting parameters are identical before and after $(0,0)$ is included. This is reasonable according to the theory since there would be no \beta-gal production before any inducer is introduced. Mathematically, $z(0) = 0$. The fitting returns a residual standard error of RSE = `r signif(summary(a_q3_fit)$sigma, 3)`; the mean standard error returns as MSE = `r signif(a_q3_mse, 3)`. The two measures of error are both quite small, hence we conclude that the model is a good fit for the data. 

### Fitting function on Data set B
First we start by fitting a straight line over the range $10 \le t \le 15 $

```{r b_q2}
# get data for 10<=t<=15
b_q2 <- novick_b %>% 
  filter(t >= 10) %>% 
  filter(t <= 15)
# fit straight line for 10<= t <= 15

b_q2_fit <- lm(b_q2$concentration ~ b_q2$t)
coef_b2 <- coef(b_q2_fit)
b_q2_summ <- summary(b_q2_fit)

print(coef_b2)

  # plot
novick_b %>%
  ggplot(aes(x = t, y = concentration)) + 
  geom_point(color = "blue") + 
  geom_point(data = b_q2, aes(color = "red"))+ 
  labs(
    title = expression(paste("Figure 4: Growth of  ", beta, 
                             "-gal Fitted to Linear Function")), 
    subtitle = "in response to lower TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("fraction of maximum  ", beta, "-gal"))
  ) + 
  geom_abline(color = "red",
    intercept = coef_b2[[1]], 
    slope = coef_b2[[2]])  + 
  theme(legend.position = "none")

# compare fit
print(b_q2_summ)

# fit same line over the entire dataset
# predict with linear model with entire dataset
b_q2_pred <- predict(b_q2_fit, newdata = data.frame(t = b_q2$t))
b_q2_mse <- mean((b_q2$concentration - b_q2_pred)^2)

b_q2_pred_all <- predict(b_q2_fit, newdata = data.frame(t = novick_b$t))
b_q2_mse_all <- mean((novick_b$concentration - b_q2_pred_all)^2)

tibble(MSE = c(b_q2_mse, b_q2_mse_all)) %>%
  signif(3) %>%
  mutate(data = c("10<= t <= 15", "entire dataset")) %>%
  print()


```

As shown in figure 4, the straight line (in red) is fitted over the data between 10 and 15 hours, over which the line fits quite well. the Mean Standard Error (MSE) for the model is much smaller within the range of 10\<= t \<= 15 with a MSE of `r b_q2_mse`, but not well over the entire data set with a MSE of `r b_q2_mse_all`. Near the low end of t, 

```{r b_q3}
# fit function from a
# define function
growth_b3 <- function (t, ampl, tau) (ampl*(1- exp(-(t/tau))))

# generate an example function
# downscale function from A

# plot the fitted function
novick_b %>%
  ggplot(aes(x = t, y = concentration)) + 
  geom_point() + 
  labs( 
    title = expression(paste("Figure 5: Growth of  ", beta, 
                             "-gal Fitted to Nonlinear Function")), 
    subtitle = "in response to lower TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("fraction of maximum  ", beta, "-gal"))
  )  +
  stat_function(aes(color = "Fitting Tau"),
    fun = growth_b3, 
                args = c(ampl = 0.3, 
                         tau = 15)) +
  stat_function(aes(color = "Fitting A"),
                fun = growth_b3, 
                args = c(ampl = 20, 
                         tau = 8)) +
  scale_color_manual(breaks = )
```

While attempting to fit data set A's function ($z(t) = A(1 - e^{-\frac{t}{\tau}})$) over data set B, we realize that it is impossible to fit. If we were to fit the function around the range $t \le 15$, the data point would inevitably exceed the value for $A$ (See Figure 5a), which is impossible since $A$ defines the theoretical maximum amount of \beta-gal that can exist in the system. Alternatively, if we try to find a value for $A$, it would be 


```{r b_q4}
# Separate data for t<= 15

b_q4_df <- novick_b %>%
  filter(t <= 15)


# define function
growth_b4 <- function (t, beta, tau) (beta * (-1 + t/tau + exp(-t/tau)))

# fit function
b_q4 <- nls(b_q4_df$concentration ~ growth_b4(t, beta, tau), 
            data = b_q4_df, start = list(beta = 1, tau = 4))

coef_b4 <- coef(b_q4)

# plot the new fitted function
# the data of t>15 is in blue and the rest is in red

b_q4_df %>%
  ggplot(aes(x = t, y = concentration)) +
  geom_point(data = novick_b, color = "black")+
  geom_point(aes(color = 'Nonlinear'))+
  geom_point(data = b_q2, aes(color = 'Linear')) + 
  labs( 
    title = expression(paste("Growth of  ", beta, 
                             "-gal Fitted Comparisons Between Two Functions")), 
    subtitle = "in response to high TMG concentration", 
    x = "time (hours)", 
    y = expression(paste("fraction of maximum  ", beta, "-gal"))
    ) +
  geom_abline(color = "red", 
              intercept = coef_b2[[1]], 
              slope = coef_b2[[2]]) +
  stat_function(aes(color = 'Nonlinear'), 
                fun = growth_b4, 
                args = c(beta = coef_b4[[1]], 
                         tau = coef_b4[[2]]))

b_q4 %>% 
  summary() %>%
  print()
```

## Appendix: 
Complete Data: 
```{r appendix}
kable(signif(novick_a, 3))
kable(signif(novick_b, 3))

```

